"use strict";const StorageManager={INTERNAL_KEYS:{AI_CURRENT_TEST:"testify_current_test",AI_LIBRARY:"testify_test_library_v1"},initializeUser(){let t=Utils.getFromStorage(Config.STORAGE_KEYS.USER_DATA);return t&&"object"==typeof t?(t.stats&&"object"==typeof t.stats||(t.stats={}),t.stats=Object.assign({totalTests:0,totalQuestions:0,correctAnswers:0,wrongAnswers:0,totalTime:0,xp:0,level:1,streak:0,lastTestDate:null,rank:null},t.stats),t.settings&&"object"==typeof t.settings||(t.settings={}),t.settings=Object.assign({theme:Config.THEME&&Config.THEME.DEFAULT?Config.THEME.DEFAULT:"light",notifications:{email:!0,push:!1},privacy:{showInLeaderboard:!0,shareProgress:!1}},t.settings),t.settings.notifications||(t.settings.notifications={email:!0,push:!1}),t.settings.privacy||(t.settings.privacy={showInLeaderboard:!0,shareProgress:!1}),t.lastLogin=Date.now(),Utils.setToStorage(Config.STORAGE_KEYS.USER_DATA,t),t):(t={id:Utils.generateId(),username:"user"+Math.floor(1e4*Math.random()),email:"",avatar:"",createdAt:Date.now(),lastLogin:Date.now(),stats:{totalTests:0,totalQuestions:0,correctAnswers:0,wrongAnswers:0,totalTime:0,xp:0,level:1,streak:0,lastTestDate:null,rank:null},settings:{theme:Config.THEME&&Config.THEME.DEFAULT?Config.THEME.DEFAULT:"light",notifications:{email:!0,push:!1},privacy:{showInLeaderboard:!0,shareProgress:!1}}},Utils.setToStorage(Config.STORAGE_KEYS.USER_DATA,t),t)},getUserData(){Utils.getFromStorage(Config.STORAGE_KEYS.USER_DATA);return this.initializeUser()},updateUserData(t){try{const e=this.getUserData(),s={...e,...t};return t&&t.stats&&(s.stats={...e.stats,...t.stats}),t&&t.settings&&(s.settings={...e.settings,...t.settings}),Utils.setToStorage(Config.STORAGE_KEYS.USER_DATA,s)}catch(t){return console.error("KullanÄ±cÄ± verisi gÃ¼ncelleme hatasÄ±:",t),!1}},updateUserStats(t){try{const e=this.getUserData();e.stats={...e.stats,...t};const s=this.calculateLevel(e.stats.xp);return s>e.stats.level&&(e.stats.level=s,Utils.showToast(`ðŸŽ‰ Level ${s}! Tebrikler!`,"success")),this.updateStreak(e),Utils.setToStorage(Config.STORAGE_KEYS.USER_DATA,e)}catch(t){return console.error("Ä°statistik gÃ¼ncelleme hatasÄ±:",t),!1}},calculateLevel(t){try{const e=Config.LEVELING.LEVEL_UP_BASE,s=Config.LEVELING.LEVEL_UP_MULTIPLIER;let r=1,a=e;for(;t>=a;)r++,a=Math.floor(e*Math.pow(s,r-1));return r}catch(e){return"number"!=typeof t||t<=0||t<100?1:t<250?2:t<500?3:t<1e3?4:5}},updateStreak(t){const e=(new Date).setHours(0,0,0,0),s=t.stats.lastTestDate?new Date(t.stats.lastTestDate).setHours(0,0,0,0):null;if(s){const r=Math.floor((e-s)/864e5);0===r||(1===r?t.stats.streak++:t.stats.streak=1)}else t.stats.streak=1;t.stats.lastTestDate=Date.now()},saveTestResult(t){try{const e={...this.getUserData().stats};e.totalTests++,e.totalQuestions+=t.totalQuestions,e.correctAnswers+=t.correctAnswers,e.wrongAnswers+=t.wrongAnswers,e.totalTime+=t.time;let s=Config.LEVELING.XP_PER_TEST;return s+=t.correctAnswers*Config.LEVELING.XP_PER_CORRECT,t.successRate>=80&&(s+=20),e.xp+=s,this.updateUserStats(e),this.saveActivity({type:"test_completed",data:t,timestamp:Date.now()}),this.updateLeaderboard(),Utils.showToast(`+${s} XP kazandÄ±n!`,"success"),!0}catch(t){return console.error("Test sonucu kaydetme hatasÄ±:",t),!1}},saveActivity(t){try{let e=Utils.getFromStorage(Config.STORAGE_KEYS.ACTIVITY,[]);Array.isArray(e)||(e=[]),e.unshift(t),e.length>50&&(e=e.slice(0,50)),Utils.setToStorage(Config.STORAGE_KEYS.ACTIVITY,e)}catch(t){console.error("Aktivite kaydetme hatasÄ±:",t)}},getActivities(t=10){const e=Utils.getFromStorage(Config.STORAGE_KEYS.ACTIVITY,[]);return Array.isArray(e)?e.slice(0,t):[]},saveNote(t){try{const e=this.getNotes();if(t.id){const s=e.findIndex((e=>e.id===t.id));-1!==s&&(e[s]={...e[s],...t,updatedAt:Date.now()})}else t.id=Utils.generateId(),t.createdAt=Date.now(),t.updatedAt=Date.now(),e.unshift(t);return Utils.setToStorage(Config.STORAGE_KEYS.NOTES,e),Config.SUCCESS&&Config.SUCCESS.SAVED&&Utils.showToast(Config.SUCCESS.SAVED,"success"),!0}catch(t){return console.error("Not kaydetme hatasÄ±:",t),Config.ERRORS&&Config.ERRORS.GENERIC&&Utils.showToast(Config.ERRORS.GENERIC,"error"),!1}},getNotes(){const t=Utils.getFromStorage(Config.STORAGE_KEYS.NOTES,[]);return Array.isArray(t)?t:[]},deleteNote(t){try{let e=this.getNotes();return e=e.filter((e=>e.id!==t)),Utils.setToStorage(Config.STORAGE_KEYS.NOTES,e),Config.SUCCESS&&Config.SUCCESS.DELETED&&Utils.showToast(Config.SUCCESS.DELETED,"success"),!0}catch(t){return console.error("Not silme hatasÄ±:",t),Config.ERRORS&&Config.ERRORS.GENERIC&&Utils.showToast(Config.ERRORS.GENERIC,"error"),!1}},updateLeaderboard(){try{const t=this.getUserData();let e=Utils.getFromStorage(Config.STORAGE_KEYS.LEADERBOARD,[]);Array.isArray(e)||(e=[]);const s=e.findIndex((e=>e.id===t.id)),r={id:t.id,username:t.username,xp:t.stats.xp,level:t.stats.level,totalTests:t.stats.totalTests,successRate:t.stats.totalQuestions>0?Math.round(t.stats.correctAnswers/t.stats.totalQuestions*100):0,updatedAt:Date.now()};-1!==s?e[s]=r:e.push(r),e.sort(((t,e)=>e.xp-t.xp));const a=Config.LEADERBOARD&&Config.LEADERBOARD.MAX_ENTRIES?Config.LEADERBOARD.MAX_ENTRIES:100;e.length>a&&(e=e.slice(0,a)),e.forEach(((t,e)=>{t.rank=e+1})),Utils.setToStorage(Config.STORAGE_KEYS.LEADERBOARD,e);const o=e.find((e=>e.id===t.id));o&&this.updateUserData({stats:{...t.stats,rank:o.rank}})}catch(t){console.error("Leaderboard gÃ¼ncelleme hatasÄ±:",t)}},getLeaderboard(t=100){const e=Utils.getFromStorage(Config.STORAGE_KEYS.LEADERBOARD,[]);return Array.isArray(e)?e.slice(0,t):[]},saveQuizState(t){try{Utils.setToStorage(Config.STORAGE_KEYS.QUIZ_STATE,{...t,savedAt:Date.now()})}catch(t){console.error("Quiz durumu kaydedilemedi:",t)}},getQuizState(){const t=Utils.getFromStorage(Config.STORAGE_KEYS.QUIZ_STATE);return t&&t.savedAt&&Date.now()-t.savedAt>36e5?(this.clearQuizState(),null):t||null},clearQuizState(){try{Utils.removeFromStorage(Config.STORAGE_KEYS.QUIZ_STATE)}catch(t){console.error("Quiz durumu temizlenemedi:",t)}},saveSettings(t){try{const e=this.getUserData();return e.settings={...e.settings,...t},Utils.setToStorage(Config.STORAGE_KEYS.USER_DATA,e)}catch(t){return console.error("Ayar kaydetme hatasÄ±:",t),!1}},async resetAllData(){if(!await Utils.confirm("TÃ¼m veriler silinecek! Bu iÅŸlem geri alÄ±namaz. Emin misiniz?"))return!1;try{return Object.values(Config.STORAGE_KEYS).forEach((t=>{Utils.removeFromStorage(t)})),Object.values(this.INTERNAL_KEYS).forEach((t=>{try{localStorage.removeItem(t)}catch(t){}})),this.initializeUser(),Utils.showToast("TÃ¼m veriler sÄ±fÄ±rlandÄ±.","success"),setTimeout((()=>{window.location.reload()}),1500),!0}catch(t){return console.error("Veri sÄ±fÄ±rlama hatasÄ±:",t),Config.ERRORS&&Config.ERRORS.GENERIC&&Utils.showToast(Config.ERRORS.GENERIC,"error"),!1}},exportData(){try{const t={version:Config.APP_VERSION,exportedAt:Date.now(),userData:this.getUserData(),notes:this.getNotes(),activities:this.getActivities(50),leaderboard:this.getLeaderboard(100)};return JSON.stringify(t,null,2)}catch(t){return console.error("Veri dÄ±ÅŸa aktarma hatasÄ±:",t),null}},async importData(t){if(!await Utils.confirm("Mevcut veriler silinip yeni veriler yÃ¼klenecek. Emin misiniz?"))return!1;try{const e=JSON.parse(t);return e.version&&e.version!==Config.APP_VERSION&&Utils.showToast("Uyumsuz veri versiyonu! Yine de yÃ¼kleniyor...","warning"),e.userData&&Utils.setToStorage(Config.STORAGE_KEYS.USER_DATA,e.userData),e.notes&&Utils.setToStorage(Config.STORAGE_KEYS.NOTES,e.notes),e.activities&&Utils.setToStorage(Config.STORAGE_KEYS.ACTIVITY,e.activities),e.leaderboard&&Utils.setToStorage(Config.STORAGE_KEYS.LEADERBOARD,e.leaderboard),Utils.showToast("Veriler baÅŸarÄ±yla yÃ¼klendi!","success"),setTimeout((()=>{window.location.reload()}),1500),!0}catch(t){return console.error("Veri iÃ§e aktarma hatasÄ±:",t),Utils.showToast("GeÃ§ersiz veri formatÄ±!","error"),!1}},saveTestToLibrary(t){try{if(!t)return;const e=Date.now(),s=864e5,r=localStorage.getItem(this.INTERNAL_KEYS.AI_LIBRARY);let a=[];if(r)try{a=JSON.parse(r),Array.isArray(a)||(a=[])}catch(t){a=[]}const o={id:t.id||Utils.generateId(),title:t.title||"AI Test",description:t.description||"",questionCount:Array.isArray(t.questions)?t.questions.length:0,createdAt:e,expiresAt:e+s,data:t};a.unshift(o),a.length>20&&(a=a.slice(0,20)),localStorage.setItem(this.INTERNAL_KEYS.AI_LIBRARY,JSON.stringify(a))}catch(t){console.error("AI test library kaydetme hatasÄ±:",t)}},getLibraryTests(){try{const t=localStorage.getItem(this.INTERNAL_KEYS.AI_LIBRARY);if(!t)return[];let e=JSON.parse(t);if(!Array.isArray(e))return[];const s=Date.now();return e=e.filter((t=>!t.expiresAt||t.expiresAt>s)),localStorage.setItem(this.INTERNAL_KEYS.AI_LIBRARY,JSON.stringify(e)),e}catch(t){return console.error("AI test library okuma hatasÄ±:",t),[]}},deleteLibraryTest(t){try{const e=localStorage.getItem(this.INTERNAL_KEYS.AI_LIBRARY);if(!e)return;let s=JSON.parse(e);if(!Array.isArray(s))return;s=s.filter((e=>e.id!==t)),localStorage.setItem(this.INTERNAL_KEYS.AI_LIBRARY,JSON.stringify(s))}catch(t){console.error("AI test library silme hatasÄ±:",t)}}};window.StorageManager=StorageManager;
