"use strict";const QuizManager={state:{currentMode:null,questions:[],currentIndex:0,answers:[],startTime:null,timerInterval:null,elapsedSeconds:0,isReviewing:!1,testTitle:null,testDescription:null,eventListenersAttached:!1},getCorrectIndex(e){if(!e||!Array.isArray(e.o))return-1;const t=["A","B","C","D","E"],s=e.a;if("number"==typeof e.answerIndex)return e.answerIndex;if("number"==typeof s)return s;if("string"==typeof s){const n=s.trim();if(/^[A-E]$/i.test(n))return t.indexOf(n.toUpperCase());const i=n.replace(/^\s*[A-E]\)\s*/i,"").trim();return e.o.findIndex((e=>{if(!e)return!1;const t=String(e);return t.replace(/^\s*[A-E]\)\s*/i,"").trim()===i||t.trim()===n}))}return-1},loadAIGeneratedTest(){try{let e=localStorage.getItem("testify_generated_test")||localStorage.getItem("testify_current_test");if(!e)return console.log("‚ÑπÔ∏è AI testi bulunamadƒ±"),null;const t=JSON.parse(e);return t.expiresAt||(t.expiresAt=Date.now()+864e5,localStorage.setItem("testify_generated_test",JSON.stringify(t))),t.expiresAt&&Date.now()>t.expiresAt?(console.log("‚è∞ AI testi s√ºresi dolmu≈ü"),localStorage.removeItem("testify_generated_test"),localStorage.removeItem("testify_current_test"),null):(console.log("‚úÖ AI testi y√ºklendi:",t.title),console.log("üìä Soru sayƒ±sƒ±:",t.questions.length),t)}catch(e){return console.error("‚ùå AI test y√ºkleme hatasƒ±:",e),null}},startQuiz(e){console.log("üéØ Quiz ba≈ülatƒ±lƒ±yor, mod:",e),this.cleanupPreviousQuiz();try{const t=this.loadAIGeneratedTest();if(t&&t.questions&&t.questions.length>0)console.log("ü§ñ AI testi kullanƒ±lƒ±yor"),this.state={currentMode:"ai",questions:t.questions,currentIndex:0,answers:[],startTime:Date.now(),timerInterval:null,elapsedSeconds:0,isReviewing:!1,testTitle:t.title,testDescription:t.description,eventListenersAttached:this.state.eventListenersAttached},this.state.answers=new Array(t.questions.length).fill(null),Utils.showToast(`ü§ñ AI Testi: ${t.title} - ${t.questions.length} soru`,"info",4e3);else{if(console.log("üìö Varsayƒ±lan sorular kullanƒ±lƒ±yor"),!window.questionBank||!Array.isArray(window.questionBank))return Utils.showToast("Soru bankasƒ± y√ºklenemedi!","error"),void console.error("questionBank bulunamadƒ±!");if(0===window.questionBank.length)return void Utils.showToast("Soru bankasƒ± bo≈ü!","error");const t=[...window.questionBank];this.state={currentMode:e,questions:Utils.shuffleArray(t),currentIndex:0,answers:[],startTime:Date.now(),timerInterval:null,elapsedSeconds:0,isReviewing:!1,testTitle:null,testDescription:null,eventListenersAttached:this.state.eventListenersAttached},this.state.answers=new Array(this.state.questions.length).fill(null)}console.log(`‚úÖ ${this.state.questions.length} soru y√ºklendi`);const s=document.getElementById("testSelection"),n=document.getElementById("quizPage");if(!s||!n)throw new Error("Quiz sayfalarƒ± bulunamadƒ±");s.classList.remove("active"),n.classList.add("active"),this.showExitButton(),this.startTimer(),this.displayQuestion(),this.saveState();const i=this.state.questions.length;Utils.showToast(`Test ba≈üladƒ±! ${i} soru - Bol ≈üans!`,"success")}catch(e){console.error("‚ùå Quiz ba≈ülatma hatasƒ±:",e),Utils.showToast("Test ba≈ülatƒ±lamadƒ±: "+e.message,"error")}},cleanupPreviousQuiz(){this.state.timerInterval&&(clearInterval(this.state.timerInterval),this.state.timerInterval=null,console.log("üßπ √ñnceki timer temizlendi"));const e=document.getElementById("optionsList");e&&(e.innerHTML="")},showExitButton(){const e=document.getElementById("exitQuizBtn");e&&(e.style.display=this.state.isReviewing?"none":"inline-flex")},saveState(){try{window.StorageManager&&StorageManager.saveQuizState({currentMode:this.state.currentMode,currentIndex:this.state.currentIndex,answers:this.state.answers,startTime:this.state.startTime,elapsedSeconds:this.state.elapsedSeconds,questionCount:this.state.questions.length})}catch(e){console.warn("Quiz durumu kaydedilemedi:",e)}},startTimer(){this.state.timerInterval&&clearInterval(this.state.timerInterval),this.state.timerInterval=setInterval((()=>{this.state.elapsedSeconds++,this.updateTimerDisplay(),this.state.elapsedSeconds%10==0&&this.saveState()}),1e3)},stopTimer(){this.state.timerInterval&&(clearInterval(this.state.timerInterval),this.state.timerInterval=null,console.log("‚èπÔ∏è Timer durduruldu"))},updateTimerDisplay(){const e=document.getElementById("quizTimer");e&&(e.textContent=Utils.formatTime(this.state.elapsedSeconds))},displayQuestion(){try{const e=this.state.questions[this.state.currentIndex];if(!e)throw new Error("Soru bulunamadƒ±");const t=document.getElementById("currentQuestion"),s=document.getElementById("totalQuestionsQuiz");t&&(t.textContent=this.state.currentIndex+1),s&&(s.textContent=this.state.questions.length);const n=(this.state.currentIndex+1)/this.state.questions.length*100,i=document.getElementById("progressFill");if(i){i.style.width=n+"%";const e=i.parentElement;e&&e.setAttribute("aria-valuenow",Math.round(n))}const a=document.getElementById("questionText");a&&(a.textContent=e.q),this.displayOptions(e),this.updateButtons()}catch(e){console.error("Soru g√∂sterme hatasƒ±:",e),Utils.showToast("Soru g√∂sterilemedi","error")}},displayOptions(e){const s=document.getElementById("optionsList");if(!s)return;s.innerHTML="";const n=["A","B","C","D","E"],i=this.getCorrectIndex(e);if(e.o.forEach(((e,t)=>{const a=document.createElement("div");a.className="option-item",a.setAttribute("role","radio"),a.setAttribute("aria-checked","false"),a.setAttribute("tabindex","0");const r=this.state.answers[this.state.currentIndex]===t;if(r&&(a.classList.add("selected"),a.setAttribute("aria-checked","true")),this.state.isReviewing){a.classList.add("disabled");const e=t===i,s=r;e&&a.classList.add("correct"),s&&!e&&a.classList.add("incorrect")}const o=String(e).replace(/^\s*[A-E]\)\s*/i,"");if(a.innerHTML=`\n                <span class="option-letter">${n[t]}</span>\n                <span>${Utils.sanitizeHTML(o)}</span>\n            `,!this.state.isReviewing){const e=()=>this.selectOption(t),s=e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),this.selectOption(t))};a.addEventListener("click",e),a.addEventListener("keypress",s)}s.appendChild(a)})),this.state.isReviewing&&e.explanation){const n=document.createElement("div");n.className="question-explanation",n.innerHTML=`\n                <div class="explanation-header">\n                    <span class="explanation-icon">üí°</span>\n                    <strong>${window.t?t("quiz.explanation","A√ßƒ±klama"):"A√ßƒ±klama"}:</strong>\n                </div>\n                <p>${Utils.sanitizeHTML(e.explanation)}</p>\n            `,s.appendChild(n)}},selectOption(e){if(!this.state.isReviewing)try{const t=this.state.questions[this.state.currentIndex],s=this.getCorrectIndex(t),n=e===s;this.state.answers[this.state.currentIndex]=e,document.querySelectorAll(".option-item").forEach(((t,i)=>{t.classList.add("disabled"),t.style.pointerEvents="none",i===s&&t.classList.add("correct"),i!==e||n||t.classList.add("incorrect"),i===e?(t.classList.add("selected"),t.setAttribute("aria-checked","true")):(t.classList.remove("selected"),t.setAttribute("aria-checked","false"))})),this.showExplanation(t,n),this.saveState()}catch(e){console.error("Se√ßenek se√ßme hatasƒ±:",e)}},showExplanation(e,s){const n=document.querySelector(".question-explanation");if(n&&n.remove(),!e.explanation)return;const i=document.getElementById("optionsList");if(!i)return;const a=document.createElement("div");a.className="question-explanation",a.style.cssText="margin-top: 20px; padding: 15px; background: var(--bg-tertiary); border-left: 4px solid var(--info); border-radius: 8px; animation: slideIn 0.3s ease-out;";const r=s?"‚úÖ":"‚ùå",o=s?window.t?t("quiz.correct","Doƒüru!"):"Doƒüru!":window.t?t("quiz.wrong","Yanlƒ±≈ü!"):"Yanlƒ±≈ü!",l=s?"var(--success)":"var(--danger)";a.innerHTML=`\n            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">\n                <span style="font-size: 1.2rem;">${r}</span>\n                <strong style="color: ${l}; font-size: 1.1rem;">${o}</strong>\n            </div>\n            <div style="display: flex; align-items: flex-start; gap: 8px; margin-top: 10px;">\n                <span style="font-size: 1.2rem;">üí°</span>\n                <div>\n                    <strong style="color: var(--info);">${window.t?t("quiz.explanation","A√ßƒ±klama"):"A√ßƒ±klama"}:</strong>\n                    <p style="color: var(--text-secondary); line-height: 1.6; margin: 5px 0 0;">${Utils.sanitizeHTML(e.explanation)}</p>\n                </div>\n            </div>\n        `,i.appendChild(a)},updateButtons(){const e=document.getElementById("prevBtn"),s=document.getElementById("nextBtn"),n=document.getElementById("submitBtn"),i=0===this.state.currentIndex,a=this.state.currentIndex===this.state.questions.length-1;if(e&&(e.disabled=i,!i||this.state.isReviewing?(e.style.display="inline-flex",e.style.opacity=i?"0.5":"1"):e.style.display="none"),s)if(this.state.isReviewing){s.style.display=a?"none":"inline-flex";const e=window.t?t("quiz.next","Sonraki"):"Sonraki";s.innerHTML=`${e} ‚Üí`}else s.style.display=a?"none":"inline-flex";n&&(n.style.display=a&&!this.state.isReviewing?"inline-flex":"none"),this.showExitButton()},nextQuestion(){this.state.currentIndex<this.state.questions.length-1&&(this.state.currentIndex++,this.displayQuestion(),this.saveState(),window.scrollTo({top:0,behavior:"smooth"}))},previousQuestion(){this.state.currentIndex>0&&(this.state.currentIndex--,this.displayQuestion(),this.saveState(),window.scrollTo({top:0,behavior:"smooth"}))},async finishQuiz(){try{const e=this.state.answers.filter((e=>null===e)).length;if(e>0){const s=window.t?t("quiz.unansweredConfirm",`${e} soru cevaplanmadƒ±. Testi bitirmek istediƒüinizden emin misiniz?`):`${e} soru cevaplanmadƒ±. Testi bitirmek istediƒüinizden emin misiniz?`;if(!await Utils.confirm(s))return}this.stopTimer();const s=this.calculateResults();window.StorageManager&&(StorageManager.saveTestResult(s),StorageManager.clearQuizState()),localStorage.removeItem("testify_generated_test"),this.showResults(s)}catch(e){console.error("Quiz bitirme hatasƒ±:",e),Utils.showToast("Test bitirilemedi","error")}},calculateResults(){let e=0,t=0;this.state.questions.forEach(((s,n)=>{const i=this.state.answers[n];if(null!==i&&"number"==typeof i){i===this.getCorrectIndex(s)?e++:t++}}));const s=this.state.questions.length-(e+t),n=this.state.questions.length>0?Math.round(e/this.state.questions.length*100):0;return{mode:this.state.currentMode,totalQuestions:this.state.questions.length,correctAnswers:e,wrongAnswers:t,unanswered:s,successRate:n,time:this.state.elapsedSeconds,timestamp:Date.now(),testTitle:this.state.testTitle}},showResults(e){try{const t=document.getElementById("quizPage"),s=document.getElementById("resultsPage");if(!t||!s)throw new Error("Sonu√ß sayfasƒ± bulunamadƒ±");t.classList.remove("active"),s.classList.add("active");const n=document.getElementById("finalScore"),i=document.getElementById("correctAnswers"),a=document.getElementById("wrongAnswers"),r=document.getElementById("successPercent"),o=document.getElementById("totalTimeResult");n&&(n.textContent=`${e.correctAnswers}/${e.totalQuestions}`),i&&(i.textContent=e.correctAnswers),a&&(a.textContent=e.wrongAnswers),r&&(r.textContent=e.successRate+"%"),o&&(o.textContent=Utils.formatTime(e.time));const l=document.querySelector(".results-icon");l&&(e.successRate>=90?l.textContent="üèÜ":e.successRate>=75?l.textContent="üéâ":e.successRate>=60?l.textContent="üëè":e.successRate>=40?l.textContent="üí™":l.textContent="üìö"),window.scrollTo({top:0,behavior:"smooth"})}catch(e){console.error("Sonu√ß g√∂sterme hatasƒ±:",e),Utils.showToast("Sonu√ßlar g√∂sterilemedi","error")}},reviewAnswers(){try{this.state.isReviewing=!0,this.state.currentIndex=0;const e=document.getElementById("resultsPage"),s=document.getElementById("quizPage");if(!e||!s)throw new Error("Quiz sayfasƒ± bulunamadƒ±");e.classList.remove("active"),s.classList.add("active"),this.displayQuestion();const n=document.getElementById("prevBtn"),i=document.getElementById("nextBtn"),a=document.getElementById("submitBtn");n&&(n.style.display="inline-flex"),i&&(i.style.display="inline-flex"),a&&(a.style.display="none"),this.showExitButton();const r=window.t?t("quiz.reviewMode","ƒ∞nceleme modu - A√ßƒ±klamalarƒ± okuyabilirsiniz"):"ƒ∞nceleme modu - A√ßƒ±klamalarƒ± okuyabilirsiniz";Utils.showToast(r,"info"),window.scrollTo({top:0,behavior:"smooth"})}catch(e){console.error("ƒ∞nceleme modu hatasƒ±:",e),Utils.showToast("ƒ∞nceleme modu ba≈ülatƒ±lamadƒ±","error")}},newQuiz(){try{this.cleanupPreviousQuiz();const e=document.getElementById("resultsPage"),t=document.getElementById("quizPage"),s=document.getElementById("testSelection");e&&e.classList.remove("active"),t&&t.classList.remove("active"),s&&s.classList.add("active"),this.state={currentMode:null,questions:[],currentIndex:0,answers:[],startTime:null,timerInterval:null,elapsedSeconds:0,isReviewing:!1,testTitle:null,testDescription:null,eventListenersAttached:this.state.eventListenersAttached},localStorage.removeItem("testify_generated_test"),window.scrollTo({top:0,behavior:"smooth"})}catch(e){console.error("Yeni quiz ba≈ülatma hatasƒ±:",e),Utils.showToast("Yeni test ba≈ülatƒ±lamadƒ±","error")}},async exitQuiz(){if(this.state.isReviewing)return void this.newQuiz();const e=window.t?t("quiz.exitConfirm","Testi bƒ±rakmak istediƒüine emin misin?\n\nƒ∞lerleme kaydedilmeyecek!"):"Testi bƒ±rakmak istediƒüine emin misin?\n\nƒ∞lerleme kaydedilmeyecek!";if(await Utils.confirm(e))try{const e=this.state.answers.filter((e=>null!==e)).length,t=this.state.questions.length;this.cleanupPreviousQuiz(),window.StorageManager&&StorageManager.clearQuizState();const s=document.getElementById("quizPage"),n=document.getElementById("resultsPage"),i=document.getElementById("testSelection");s&&s.classList.remove("active"),n&&n.classList.remove("active"),i&&i.classList.add("active"),this.state={currentMode:null,questions:[],currentIndex:0,answers:[],startTime:null,timerInterval:null,elapsedSeconds:0,isReviewing:!1,testTitle:null,testDescription:null,eventListenersAttached:this.state.eventListenersAttached},e>0?Utils.showToast(`üìã Test bƒ±rakƒ±ldƒ± (${e}/${t} soru cevaplanmƒ±≈ütƒ±)`,"info",4e3):Utils.showToast("Test iptal edildi","info"),window.scrollTo({top:0,behavior:"smooth"})}catch(e){console.error("Quiz √ßƒ±kƒ±≈ü hatasƒ±:",e),Utils.showToast("√áƒ±kƒ±≈ü yapƒ±lamadƒ±","error")}},setupEventListeners(){if(this.state.eventListenersAttached)return void console.log("‚ö†Ô∏è Event listener'lar zaten ekli");console.log("üîß Quiz event listener'lar kuruluyor...");const e=document.querySelector(".test-options");if(e){const t=["practice","exam","ai","custom"];e.querySelectorAll(".test-option-card").forEach(((e,s)=>{const n=t[s];e.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),this.startQuiz(n)})),e.addEventListener("keypress",(e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),this.startQuiz(n))}))}))}const t=document.getElementById("prevBtn"),s=document.getElementById("nextBtn"),n=document.getElementById("submitBtn"),i=document.getElementById("reviewBtn"),a=document.getElementById("newQuizBtn"),r=document.getElementById("exitQuizBtn");t&&t.addEventListener("click",(e=>{e.preventDefault(),this.previousQuestion()})),s&&s.addEventListener("click",(e=>{e.preventDefault(),this.nextQuestion()})),n&&n.addEventListener("click",(e=>{e.preventDefault(),this.finishQuiz()})),i&&i.addEventListener("click",(e=>{e.preventDefault(),this.reviewAnswers()})),a&&a.addEventListener("click",(e=>{e.preventDefault(),this.newQuiz()})),r&&r.addEventListener("click",(e=>{e.preventDefault(),this.exitQuiz()})),this.state.eventListenersAttached=!0,console.log("‚úÖ Quiz event listener'lar kuruldu")}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{QuizManager.setupEventListeners()})):QuizManager.setupEventListeners(),window.addEventListener("beforeunload",(()=>{QuizManager.stopTimer()})),window.QuizManager=QuizManager;
